<div class="container-fluid">

    <hr>

    <div class="container">
        <div class="row">
            <div class="col">
                <h1>1. Registration</h1>
                <p>First step is to register a <code>UserAgent</code>.</p>
            </div>
        </div>
        <div *ngIf="!session" class="row">
            <div class="col"><button mat-raised-button color="primary" (click)="register()" title="Register as guest">Register as Guest&nbsp;<i class="bi bi-box-arrow-in-right"></i></button>
            </div>
            <div class="col">
                <p class="text-center">Or</p>
            </div>
            <div class="col">
                <app-login (credentials)="onCredentials($event)"></app-login>
            </div>
        </div>
        <div *ngIf="session" class="alert alert-success clearfix" role="alert">Got Session <span *ngIf="jWT">jWT=<code>{{jWT}}</code></span>
            <div class="float-right"><button mat-raised-button color="warn" (click)="unregister()" title="Unregister"><i
                        class="bi bi-box-arrow-left"></i>&nbsp;Unregister</button></div>
        </div>
        <br>
        <p *ngIf="registrationError" class="alert alert-danger" role="alert">{{registrationError | json}}
        </p>
    </div>

    <hr>

    <div class="container">
        <div class="row">
            <div class="col">
                <h1>2. The Conversation</h1>
            </div>
        </div>
        <div class="row">
            <div class="text-center">
                <form *ngIf="!conversation" [formGroup]="formGroup" (ngSubmit)="getOrcreateConversation()">
                    <mat-form-field>
                        <mat-label>Nom de la conversation</mat-label>
                        <span matPrefix>{{convBaseUrl}}/</span>
                        <input type="text" matInput placeholder="abcd" formControlName="convName">
                        <!-- <mat-icon matSuffix>mode_edit</mat-icon> -->
                    </mat-form-field>&nbsp;
                    <button mat-raised-button color="primary" type="submit" [disabled]="!formGroup.valid||!session" title="Get Or Create Conversation">GetOrCreateConversation&nbsp;<i
                            class="bi bi-telephone-forward-fill"></i></button>

                </form>

                <p *ngIf="conversation">{{convUrl}}&nbsp;<button mat-raised-button color="primary" [cdkCopyToClipboard]="convUrl" title="Copy link"><i class="bi bi-share"></i></button>
                    <button mat-raised-button color="primary" (click)="!joined?join():leave()" title="{{!joined?'Join':'Leave'}} Conversation">{{!joined?'Join':'Leave'}}</button>
                    <button mat-raised-button color="warn" (click)="destroy()" title="Destroy Conversation">Destroy</button>
                </p>
            </div>
        </div>
    </div>

    <hr>

    <div class="container">
        <div class="row">
            <div class="col">
                <h1>3. Streams</h1>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body">

            <div id="videos" class="row row-cols-1 row-cols-sm-2">
                <div class="col mycard">
                    <div id="{{localStream?.stream.streamId}}" class="embed-responsive embed-responsive-4by3">
                        <video #localVideo muted autoplay playsinline></video>
                        <div class="mycard-text">
                            <!-- <h5 *ngIf="usernameFc.value">{{usernameFc.value}}</h5> -->
                            <form class="row row-cols-lg-auto g-3 align-items-center">
                                <div class="col-12">
                                    <mat-form-field appearance="outline">
                                        <mat-label>Name</mat-label>
                                        <input matInput placeholder="Name" [formControl]="usernameFc">
                                        <mat-icon matSuffix>sentiment_very_satisfied</mat-icon>
                                        <mat-hint>Enter your name</mat-hint>
                                    </mat-form-field>
                                    <br>
                                    <mat-form-field appearance="fill">
                                        <mat-label>VideoIn</mat-label>
                                        <mat-select [formControl]="videoFc">
                                            <mat-option *ngFor="let device of videoDevices" [value]="device.id">
                                                {{device.label}}
                                            </mat-option>
                                        </mat-select>
                                    </mat-form-field>
                                    <mat-form-field appearance="fill">
                                        <mat-label>AudioIn</mat-label>
                                        <mat-select [formControl]="audioInFc">
                                            <mat-option *ngFor="let device of audioInDevices" [value]="device">
                                                {{device.label}}
                                            </mat-option>
                                        </mat-select>
                                    </mat-form-field>
                                </div>
                            </form>
                            <app-audio-stats [stats]="localStream?.qosStat?.audioSent"></app-audio-stats>
                            <app-video-stats [stats]="localStream?.qosStat?.videoSent"></app-video-stats>
                        </div>
                        <div class="mycard-over">
                            <pre>
<code>streamId:{{localStream?.streamId}}</code>
<code>callId:{{localStream?.callId}}</code>
                            </pre>
                            <mat-icon *ngIf="localStream?.isSpeaking" matSuffix>record_voice_over</mat-icon>
                        </div>
                    </div>
                </div>

                <div class="col mycard" [hidden]="!screenSharingStream">
                    <div id="{{screenSharingStream?.streamId}}" class="embed-responsive embed-responsive-4by3">
                        <video #screenSharingVideo muted autoplay playsinline></video>
                    </div>
                </div>

                <div *ngFor="let stream of streams" class="col mycard">
                    <app-peer [conversation]="conversation" [stream]="stream"></app-peer>
                </div>
            </div>
        </div>
        <div class="card-footer">

            <button mat-raised-button color="primary" (click)="!localStream?createStream():destroyStream()" [disabled]="published">{{!localStream?'Create Stream':'Release Stream'}}</button>
            <!-- publishInPrgs -->
            <button mat-raised-button color="primary" (click)="!published?publish():unpublish()" [disabled]="!joined||publishInPrgs">{{!published?'Publish Stream':'Unpublish Stream'}}
                <span *ngIf="publishInPrgs" class="spinner-border text-light" role="status"></span></button> &nbsp;
            <button mat-raised-button color="primary" (click)="toggleScreenSharing()" [disabled]="!conversation">{{screenSharingStream?'Unshare':'Share'}} Screen</button> &nbsp;
        </div>
    </div>

</div>